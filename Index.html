<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ashwitha Diet Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Line Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0fdf4; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .checkbox-wrapper input:checked + div {
            background-color: #10b981;
            border-color: #10b981;
            color: white;
            text-decoration: line-through;
            opacity: 0.7;
        }
        /* Hide scrollbar for clean look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .water-drop.active { color: #3b82f6; transform: scale(1.1); }
        .water-drop { transition: all 0.2s; color: #cbd5e1; cursor: pointer; }
    </style>
</head>
<body class="text-slate-700 min-h-screen pb-20">

    <!-- Header -->
    <header class="bg-gradient-to-r from-emerald-600 to-teal-500 text-white p-6 shadow-lg rounded-b-[2rem] sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">Ashwitha Diet Plan</h1>
                <p class="text-emerald-100 text-xs font-medium tracking-wider">76 KG <i class="fas fa-arrow-right mx-1"></i> 70 KG</p>
            </div>
            <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                <i class="fas fa-leaf text-xl"></i>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-md mx-auto p-4 space-y-6">

        <!-- Navigation Tabs -->
        <div class="flex bg-white p-1 rounded-xl shadow-sm border border-slate-100 overflow-x-auto">
            <button onclick="switchTab('tracker')" id="btn-tracker" class="flex-1 py-2 px-2 text-xs sm:text-sm font-semibold rounded-lg bg-emerald-100 text-emerald-700 transition-all whitespace-nowrap">Tracker</button>
            <button onclick="switchTab('progress')" id="btn-progress" class="flex-1 py-2 px-2 text-xs sm:text-sm font-semibold rounded-lg text-slate-500 hover:bg-slate-50 transition-all whitespace-nowrap">Progress</button>
            <button onclick="switchTab('weekly')" id="btn-weekly" class="flex-1 py-2 px-2 text-xs sm:text-sm font-semibold rounded-lg text-slate-500 hover:bg-slate-50 transition-all whitespace-nowrap">Full Plan</button>
            <button onclick="switchTab('tips')" id="btn-tips" class="flex-1 py-2 px-2 text-xs sm:text-sm font-semibold rounded-lg text-slate-500 hover:bg-slate-50 transition-all whitespace-nowrap">Tips</button>
        </div>

        <!-- TRACKER VIEW -->
        <div id="view-tracker" class="space-y-6 animate-fade-in">
            
            <!-- Date & Weight Section -->
            <div class="glass-card p-5 rounded-2xl shadow-sm border border-emerald-100">
                <div class="flex justify-between items-end mb-4">
                    <div class="w-full mr-4">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wide">Date</label>
                        <input type="date" id="currentDate" class="w-full mt-1 p-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-emerald-500 font-medium">
                    </div>
                    <div class="w-24">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wide">Weight (kg)</label>
                        <input type="number" step="0.1" id="weightInput" placeholder="76.0" class="w-full mt-1 p-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-emerald-500 font-bold text-emerald-600 text-center">
                    </div>
                </div>
                
                <!-- NEW: Daily Progress Bar in Tracker -->
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-xs font-bold text-emerald-600 uppercase tracking-wide">Daily Goal</label>
                        <span id="trackerDailyPercent" class="text-lg font-bold text-emerald-600">0%</span>
                    </div>
                    <div class="h-3 bg-emerald-100 rounded-full overflow-hidden">
                        <div id="trackerDailyBar" class="h-full bg-gradient-to-r from-emerald-500 to-teal-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="dayDisplay" class="text-center text-xs text-slate-400 mt-2 font-medium">Monday Plan Active</p>
                </div>
            </div>

            <!-- Daily Meals Tracker -->
            <div class="space-y-3" id="mealContainer">
                <!-- Meals will be injected here by JS -->
            </div>

            <!-- Water Tracker -->
            <div class="glass-card p-5 rounded-2xl shadow-sm border border-blue-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-slate-700">Water Tracker</h3>
                    <span id="waterCount" class="text-blue-500 font-bold text-sm">0/8 Glasses</span>
                </div>
                <div class="flex justify-between px-2" id="waterDrops">
                    <!-- Drops injected by JS -->
                </div>
            </div>

            <!-- Notes -->
            <div class="glass-card p-5 rounded-2xl shadow-sm">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wide">Daily Notes</label>
                <textarea id="dailyNotes" rows="3" class="w-full mt-2 p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-emerald-500" placeholder="How did you feel today?"></textarea>
            </div>
        </div>

        <!-- PROGRESS VIEW -->
        <div id="view-progress" class="hidden space-y-6">
            <!-- Summary Card -->
            <div class="bg-gradient-to-br from-emerald-600 to-teal-700 text-white p-6 rounded-2xl shadow-lg text-center relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-3xl font-bold mb-1" id="totalWeightLostDisplay">0.0 kg</h2>
                    <p class="text-emerald-100 text-sm font-medium uppercase tracking-wide">Total Weight Lost</p>
                    <div class="mt-4 bg-white/20 h-2 rounded-full overflow-hidden">
                        <div id="totalProgressBar" class="bg-white h-full rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-xs mt-2 text-emerald-100"><span id="totalPercentDisplay">0%</span> of 6kg Goal Achieved</p>
                </div>
                <i class="fas fa-chart-line absolute -bottom-4 -right-4 text-9xl text-white opacity-10"></i>
            </div>

            <!-- CHART SECTION -->
            <div class="glass-card p-4 rounded-xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700">Weight Trend</h3>
                    <div class="flex gap-2 text-xs">
                        <button onclick="updateChartRange('7')" id="btn-range-7" class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full font-semibold transition-colors">1W</button>
                        <button onclick="updateChartRange('30')" id="btn-range-30" class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full font-semibold transition-colors">1M</button>
                        <button onclick="updateChartRange('365')" id="btn-range-365" class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full font-semibold transition-colors">1Y</button>
                    </div>
                </div>
                <!-- Increased height slightly to accommodate angled labels -->
                <div class="w-full h-72">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <!-- Daily Stats -->
                <div class="glass-card p-5 rounded-xl border-l-4 border-emerald-400">
                    <h3 class="font-bold text-slate-700 mb-3 flex justify-between">
                        <span>Daily</span>
                        <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded">Today</span>
                    </h3>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-500">Diet Adherence</span>
                            <span class="font-bold text-emerald-600" id="dailyDietPercent">0%</span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div id="dailyDietBar" class="h-full bg-emerald-500 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Stats -->
                <div class="glass-card p-5 rounded-xl border-l-4 border-blue-400">
                    <h3 class="font-bold text-slate-700 mb-3 flex justify-between">
                        <span>Weekly</span>
                        <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded">Last 7 Days</span>
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-slate-500">Diet Consistency</span>
                                <span class="font-bold text-blue-600" id="weeklyDietPercent">0%</span>
                            </div>
                            <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div id="weeklyDietBar" class="h-full bg-blue-500 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Yearly Stats -->
                 <div class="glass-card p-5 rounded-xl border-l-4 border-orange-400">
                    <h3 class="font-bold text-slate-700 mb-3 flex justify-between">
                        <span>Yearly</span>
                        <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded">Last 365 Days</span>
                    </h3>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-500">Overall Consistency</span>
                            <span class="font-bold text-orange-600" id="yearlyDietPercent">0%</span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div id="yearlyDietBar" class="h-full bg-orange-500 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WEEKLY PLAN VIEW -->
        <div id="view-weekly" class="hidden space-y-4">
            <div class="bg-emerald-600 text-white p-4 rounded-xl shadow-md mb-4">
                <h3 class="font-bold text-lg">Weekly Reference</h3>
                <p class="text-sm opacity-90">Based on your PDF plan (76kg -> 70kg)</p>
            </div>
            <div id="fullPlanContainer" class="space-y-4 pb-10">
                <!-- Full plan injected via JS -->
            </div>
        </div>

        <!-- TIPS VIEW -->
        <div id="view-tips" class="hidden space-y-6">
            <div class="text-center space-y-2">
                <h2 class="text-2xl font-bold text-slate-800">Knowledge Hub</h2>
                <p class="text-sm text-slate-500">100 Tips to help you reach 70kg</p>
            </div>

            <!-- Featured Tip Card -->
            <div class="glass-card p-8 rounded-3xl shadow-lg border-2 border-emerald-100 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i class="fas fa-lightbulb text-9xl text-emerald-500"></i>
                </div>
                <div class="relative z-10">
                    <span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-3 py-1 rounded-full uppercase">Tip of the moment</span>
                    <p id="tipDisplay" class="mt-4 text-xl font-medium text-slate-700 leading-relaxed">
                        Drink a glass of warm water with lemon immediately after waking up to boost metabolism.
                    </p>
                    <button onclick="refreshTip()" class="mt-6 flex items-center justify-center w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl shadow-md transition-all active:scale-95">
                        <i class="fas fa-sync-alt mr-2"></i> Get New Tip
                    </button>
                </div>
            </div>

            <!-- List of categories -->
            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <h3 class="font-bold text-sm uppercase text-slate-400 mb-4">Did you know?</h3>
                <ul class="space-y-3 text-sm text-slate-600">
                    <li class="flex items-start"><i class="fas fa-check-circle text-emerald-500 mt-1 mr-3"></i><span>Eating slowly helps you feel full faster.</span></li>
                    <li class="flex items-start"><i class="fas fa-check-circle text-emerald-500 mt-1 mr-3"></i><span>Sleep deprivation increases hunger hormones.</span></li>
                    <li class="flex items-start"><i class="fas fa-check-circle text-emerald-500 mt-1 mr-3"></i><span>Protein requires more energy to digest than fat.</span></li>
                </ul>
            </div>
        </div>

    </main>

    <!-- Success Notification (Hidden by default) -->
    <div id="saveNotification" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 translate-y-20 opacity-0 z-50">
        <i class="fas fa-save text-emerald-400"></i>
        <span class="text-sm font-medium">Progress Saved</span>
    </div>

    <script>
        // --- 1. DATA CONFIGURATION (Based on PDF) ---
        const weeklyDietData = {
            0: { // Sunday
                name: "Sunday",
                meals: [
                    { type: "Morning", food: "Lemon water" },
                    { type: "Breakfast", food: "Dosa/idli + fruit" },
                    { type: "Lunch", food: "Chapati or rice + paneer/chicken + veg + salad" },
                    { type: "Evening", food: "Coconut water + nuts" },
                    { type: "Dinner", food: "Light meal (soup/khichdi/chapati)" }
                ]
            },
            1: { // Monday
                name: "Monday",
                meals: [
                    { type: "Morning", food: "Warm lemon water; almonds & walnut" },
                    { type: "Breakfast", food: "2 idlis + sambar + fruit" },
                    { type: "Lunch", food: "Rice (small), dal, sabzi, curd, salad" },
                    { type: "Evening", food: "Green tea + chana/peanuts" },
                    { type: "Dinner", food: "2 chapatis + sabzi; soup (optional)" }
                ]
            },
            2: { // Tuesday
                name: "Tuesday",
                meals: [
                    { type: "Morning", food: "Jeera water + nuts" },
                    { type: "Breakfast", food: "Upma + fruit" },
                    { type: "Lunch", food: "2 chapatis, dal, sabzi, salad" },
                    { type: "Evening", food: "Sprouts or fruit + green tea" },
                    { type: "Dinner", food: "Khichdi or soup + egg" }
                ]
            },
            3: { // Wednesday
                name: "Wednesday",
                meals: [
                    { type: "Morning", food: "Lemon water" },
                    { type: "Breakfast", food: "2 dosas + chutney" },
                    { type: "Lunch", food: "Rice (small), sambar, sabzi, salad" },
                    { type: "Evening", food: "Coconut water + fruit" },
                    { type: "Dinner", food: "Grilled paneer/chicken + salad" }
                ]
            },
            4: { // Thursday
                name: "Thursday",
                meals: [
                    { type: "Morning", food: "Green tea" },
                    { type: "Breakfast", food: "Oats + fruits" },
                    { type: "Lunch", food: "2 chapatis, dal, veg, curd" },
                    { type: "Evening", food: "Roasted makhana" },
                    { type: "Dinner", food: "Soup + egg whites OR chapati + light sabzi" }
                ]
            },
            5: { // Friday
                name: "Friday",
                meals: [
                    { type: "Morning", food: "Lemon water" },
                    { type: "Breakfast", food: "Poha" },
                    { type: "Lunch", food: "Rice (small), dal, curry, salad" },
                    { type: "Evening", food: "Fruit bowl + green tea" },
                    { type: "Dinner", food: "2 chapatis + sabzi + buttermilk" }
                ]
            },
            6: { // Saturday
                name: "Saturday",
                meals: [
                    { type: "Morning", food: "Jeera water" },
                    { type: "Breakfast", food: "Eggs + fruit OR Paneer bhurji" },
                    { type: "Lunch", food: "2 chapatis, dal, veg, salad" },
                    { type: "Evening", food: "Peanuts" },
                    { type: "Dinner", food: "Soup or grilled paneer/chicken" }
                ]
            }
        };

        const tipsArray = [
            "Drink a glass of water before every meal.", "Eat slowly and chew your food thoroughly.", "Use a smaller plate to control portion sizes.",
            "Avoid sugary drinks and sodas.", "Eat protein with every meal.", "Get at least 7-8 hours of sleep.",
            "Walk for 30 minutes every day.", "Reduce salt intake to prevent bloating.", "Eat more fiber-rich vegetables.",
            "Plan your meals in advance.", "Don't shop for groceries when you are hungry.", "Keep healthy snacks like nuts handy.",
            "Avoid eating late at night.", "Drink green tea instead of coffee.", "Limit processed foods.",
            "Track your calories occasionally.", "Eat whole fruits instead of drinking juice.", "Cut down on refined carbohydrates.",
            "Manage stress levels; stress causes overeating.", "Weigh yourself once a week, not every day.",
            "Swap white rice for brown rice or quinoa.", "Use olive oil for cooking.", "Eat a salad before your main course.",
            "Avoid deep-fried foods.", "Practice mindful eating.", "Put your fork down between bites.",
            "Drink black coffee before a workout.", "Eat spicy foods to boost metabolism.", "Take probiotics for gut health.",
            "Stand up more often during the day.", "Take the stairs instead of the elevator.", "Park further away to walk more.",
            "Do strength training twice a week.", "Eat eggs for breakfast.", "Drink water instead of alcohol.",
            "Brush your teeth after dinner to stop snacking.", "Keep a food journal.", "Find a weight loss buddy.",
            "Don't ban foods; eat them in moderation.", "Eat more soup.", "Visualise your weight loss goal.",
            "Take progress photos.", "Don't skip breakfast if you are hungry.", "Eat healthy fats like avocado.",
            "Avoid 'low-fat' labeled foods (often high sugar).", "Eat more broccoli and cauliflower.", "Drink cold water to burn more calories.",
            "Focus on health, not just the number on the scale.", "Forgive yourself for slip-ups.", "Celebrate non-scale victories.",
            "Eat without distractions (no TV).", "Serve sauce on the side.", "Share dessert instead of eating it all.",
            "Order first at restaurants.", "Ask for a to-go box immediately.", "Eat natural yogurt.",
            "Add chia seeds to your water.", "Snack on carrots and hummus.", "Avoid emotional eating.",
            "Identify your triggers.", "Cook at home more often.", "Read food labels carefully.",
            "Focus on single-ingredient foods.", "Eat more beans and legumes.", "Try intermittent fasting.",
            "Reduce alcohol consumption.", "Add vinegar to your diet.", "Eat whole grains.",
            "Don't drink your calories.", "Use coconut oil in moderation.", "Eat fatty fish like salmon.",
            "Get enough Vitamin D.", "Drink yerba mate.", "Chew gum to reduce cravings.",
            "Use a blue plate (psychological trick).", "Eat in front of a mirror.", "Turn down the heating (burns fat).",
            "Laugh more; it burns calories!", "Fidgeting burns calories.", "Stay hydrated during workouts.",
            "Eat watermelon for volume.", "Replace candy with fruit.", "Eat cottage cheese.",
            "Avoid creamy salad dressings.", "Use mustard instead of mayo.", "Grill instead of fry.",
            "Steam your vegetables.", "Eat the skin of fruits (fiber).", "Eat pumpkin seeds.",
            "Drink lemon water.", "Use spices like turmeric.", "Eat almonds in moderation.",
            "Eat walnuts for brain health.", "Avoid trans fats completely.", "Check sugar content in cereals.",
            "Eat oats for breakfast.", "Drink whey protein.", "Do HIIT workouts.", "Stay consistent!"
        ];

        // --- 2. STATE & STORAGE MANAGEMENT ---
        const APP_PREFIX = "ashwitha_diet_";
        let currentDate = new Date().toISOString().split('T')[0];
        let weightChartInstance = null; // Store chart instance
        let currentChartRange = 7; // Default 7 days

        // START WEIGHT & GOAL
        const START_WEIGHT = 76.0;
        const TARGET_WEIGHT = 70.0;
        const TOTAL_GOAL = START_WEIGHT - TARGET_WEIGHT;

        function getStorage(date) {
            const data = localStorage.getItem(APP_PREFIX + date);
            return data ? JSON.parse(data) : { meals: {}, weight: "", water: 0, notes: "" };
        }

        function saveStorage(date, data) {
            localStorage.setItem(APP_PREFIX + date, JSON.stringify(data));
            showSaveNotification();
        }

        function showSaveNotification() {
            const el = document.getElementById('saveNotification');
            el.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                el.classList.add('translate-y-20', 'opacity-0');
            }, 2000);
        }

        // --- 3. UI RENDERING LOGIC ---

        function init() {
            document.getElementById('currentDate').value = currentDate;
            renderTracker(currentDate);
            renderWeeklyPlan();
            refreshTip(); // Load initial tip
            setupEventListeners();
        }

        function renderTracker(dateStr) {
            const data = getStorage(dateStr);
            const dateObj = new Date(dateStr);
            const dayIndex = dateObj.getDay(); // 0 = Sunday, 1 = Monday
            const plan = weeklyDietData[dayIndex];

            // 1. Update Header Info
            document.getElementById('weightInput').value = data.weight;
            document.getElementById('dailyNotes').value = data.notes;
            document.getElementById('dayDisplay').innerText = `${plan.name} Plan Active`;

            // 2. Render Meals
            const mealContainer = document.getElementById('mealContainer');
            mealContainer.innerHTML = '';

            let totalMeals = plan.meals.length;
            let checkedMeals = 0;

            plan.meals.forEach((meal, index) => {
                const isChecked = data.meals[index] || false;
                if (isChecked) checkedMeals++;
                
                const html = `
                <div class="checkbox-wrapper glass-card p-4 rounded-xl shadow-sm border border-slate-100 flex items-start gap-4 transition-all">
                    <div class="relative flex items-center pt-1">
                        <input type="checkbox" id="meal-${index}" 
                            class="peer h-6 w-6 cursor-pointer appearance-none rounded-md border-2 border-emerald-300 transition-all checked:border-emerald-500 checked:bg-emerald-500"
                            ${isChecked ? 'checked' : ''}
                            onchange="updateMeal(${index}, this.checked)">
                        <i class="fas fa-check absolute left-1.5 top-2 text-xs text-white opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                    </div>
                    <div class="flex-1 transition-all duration-300">
                        <h4 class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">${meal.type}</h4>
                        <p class="text-sm font-medium text-slate-700 leading-snug">${meal.food}</p>
                    </div>
                </div>
                `;
                mealContainer.insertAdjacentHTML('beforeend', html);
            });

            // 3. Render Daily Percentage Bar (New Feature)
            // Weight logic: 5 meals = 100%. 
            const percent = totalMeals > 0 ? Math.round((checkedMeals / totalMeals) * 100) : 0;
            document.getElementById('trackerDailyPercent').innerText = `${percent}%`;
            document.getElementById('trackerDailyBar').style.width = `${percent}%`;


            // 4. Render Water
            renderWater(data.water);
        }

        function renderWater(count) {
            const container = document.getElementById('waterDrops');
            container.innerHTML = '';
            document.getElementById('waterCount').innerText = `${count}/8 Glasses`;

            for (let i = 1; i <= 8; i++) {
                const active = i <= count ? 'text-blue-500 scale-110' : 'text-slate-200';
                container.insertAdjacentHTML('beforeend', `
                    <i class="fas fa-tint text-2xl water-drop ${active}" onclick="updateWater(${i})"></i>
                `);
            }
        }

        function renderWeeklyPlan() {
            const container = document.getElementById('fullPlanContainer');
            const order = [1,2,3,4,5,6,0]; 
            
            order.forEach(dayIdx => {
                const day = weeklyDietData[dayIdx];
                const html = `
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <h4 class="font-bold text-emerald-700 mb-2 border-b pb-1">${day.name}</h4>
                        <div class="space-y-2 text-xs text-slate-600">
                            ${day.meals.map(m => `
                                <div class="grid grid-cols-[60px_1fr] gap-2">
                                    <span class="font-semibold text-slate-400">${m.type}:</span>
                                    <span>${m.food}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- 4. PROGRESS & CHART LOGIC ---

        function formatDate(d) {
            return d.toISOString().split('T')[0];
        }

        function calculateStats(daysLookback) {
            const today = new Date(currentDate); 
            let totalMealsPossible = 0;
            let totalMealsEaten = 0;
            
            for (let i = 0; i < daysLookback; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateKey = formatDate(d);
                const data = getStorage(dateKey);

                const dayIdx = d.getDay();
                const mealCount = weeklyDietData[dayIdx].meals.length;
                totalMealsPossible += mealCount;
                
                Object.values(data.meals).forEach(val => {
                    if(val) totalMealsEaten++;
                });
            }

            const dietPercent = totalMealsPossible > 0 ? Math.round((totalMealsEaten / totalMealsPossible) * 100) : 0;
            return { dietPercent };
        }

        function getChartData(days) {
            const labels = [];
            const dataPoints = [];
            const today = new Date(); 

            // Iterate backwards to build arrays
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateStr = formatDate(d);
                const stored = getStorage(dateStr);
                
                // --- CUSTOM LABEL FORMATTING ---
                let label;
                if (days === 7) {
                    // Weekly: "Mon Nov 27"
                    label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                } else {
                    // Monthly/Yearly: "Nov 27, 2024"
                    label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
                }

                labels.push(label);
                
                if (stored.weight && stored.weight !== "") {
                    dataPoints.push(parseFloat(stored.weight));
                } else {
                    dataPoints.push(null);
                }
            }
            return { labels, dataPoints };
        }

        function renderProgress() {
            // Header Stats
            const todayData = getStorage(currentDate);
            const currentW = todayData.weight ? parseFloat(todayData.weight) : START_WEIGHT;
            const totalLost = START_WEIGHT - currentW;
            const totalPercent = Math.min(100, Math.max(0, Math.round((totalLost / TOTAL_GOAL) * 100)));

            document.getElementById('totalWeightLostDisplay').innerText = `${totalLost.toFixed(1)} kg`;
            document.getElementById('totalPercentDisplay').innerText = `${totalPercent}%`;
            document.getElementById('totalProgressBar').style.width = `${totalPercent}%`;

            // Bar Stats
            const daily = calculateStats(1);
            document.getElementById('dailyDietPercent').innerText = `${daily.dietPercent}%`;
            document.getElementById('dailyDietBar').style.width = `${daily.dietPercent}%`;

            const weekly = calculateStats(7);
            document.getElementById('weeklyDietPercent').innerText = `${weekly.dietPercent}%`;
            document.getElementById('weeklyDietBar').style.width = `${weekly.dietPercent}%`;

            const yearly = calculateStats(365);
            document.getElementById('yearlyDietPercent').innerText = `${yearly.dietPercent}%`;
            document.getElementById('yearlyDietBar').style.width = `${yearly.dietPercent}%`;

            // Render Chart
            renderChart(currentChartRange);
        }

        function updateChartRange(days) {
            currentChartRange = parseInt(days);
            // Update active button styles
            ['7', '30', '365'].forEach(d => {
                const btn = document.getElementById(`btn-range-${d}`);
                if (d === days.toString()) {
                    btn.classList.remove('bg-slate-100', 'text-slate-500');
                    btn.classList.add('bg-emerald-100', 'text-emerald-700');
                } else {
                    btn.classList.add('bg-slate-100', 'text-slate-500');
                    btn.classList.remove('bg-emerald-100', 'text-emerald-700');
                }
            });
            renderChart(currentChartRange);
        }

        function renderChart(days) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const { labels, dataPoints } = getChartData(days);

            // Determine smart tick limits
            let maxTicks = 7;
            if (days === 30) maxTicks = 10;  
            if (days === 365) maxTicks = 12; 

            // Destroy existing chart if it exists
            if (weightChartInstance) {
                weightChartInstance.destroy();
            }

            weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (kg)',
                        data: dataPoints,
                        borderColor: '#10b981', 
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#059669',
                        pointRadius: days > 30 ? 2 : 4,
                        pointHoverRadius: 6,
                        tension: 0.3,
                        fill: true,
                        spanGaps: true 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' kg';
                                }
                            },
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#334155',
                            bodyColor: '#10b981',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            boxPadding: 4
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f1f5f9' },
                            suggestedMin: 68,
                            suggestedMax: 78,
                            ticks: {
                                font: { size: 10, family: 'Poppins' },
                                color: '#94a3b8'
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: maxTicks,
                                maxRotation: 45, // INCLINED LABELS (45 degrees)
                                minRotation: 45, // INCLINED LABELS (45 degrees)
                                autoSkip: true,
                                font: { size: 10, family: 'Poppins' },
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }


        // --- 5. INTERACTIVITY & EVENTS ---

        function setupEventListeners() {
            // Date Change
            document.getElementById('currentDate').addEventListener('change', (e) => {
                currentDate = e.target.value;
                renderTracker(currentDate);
                renderProgress();
            });

            // Weight Save
            document.getElementById('weightInput').addEventListener('change', (e) => {
                const data = getStorage(currentDate);
                data.weight = e.target.value;
                saveStorage(currentDate, data);
                renderProgress();
            });

            // Notes Save
            document.getElementById('dailyNotes').addEventListener('change', (e) => {
                const data = getStorage(currentDate);
                data.notes = e.target.value;
                saveStorage(currentDate, data);
            });
        }

        function updateMeal(index, isChecked) {
            const data = getStorage(currentDate);
            data.meals[index] = isChecked;
            saveStorage(currentDate, data);
            renderTracker(currentDate); // Re-render to update the Daily Percentage Bar
            renderProgress(); 
        }

        function updateWater(count) {
            const data = getStorage(currentDate);
            if (data.water === count) {
                data.water = count - 1;
            } else {
                data.water = count;
            }
            saveStorage(currentDate, data);
            renderWater(data.water);
        }

        function refreshTip() {
            const randomTip = tipsArray[Math.floor(Math.random() * tipsArray.length)];
            const display = document.getElementById('tipDisplay');
            
            display.style.opacity = 0;
            setTimeout(() => {
                display.innerText = randomTip;
                display.style.opacity = 1;
            }, 200);
        }

        // --- 6. TAB NAVIGATION ---
        window.switchTab = function(tabName) {
            ['tracker', 'weekly', 'tips', 'progress'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                const btn = document.getElementById(`btn-${t}`);
                btn.classList.remove('bg-emerald-100', 'text-emerald-700');
                btn.classList.add('text-slate-500');
            });

            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`btn-${tabName}`);
            activeBtn.classList.remove('text-slate-500');
            activeBtn.classList.add('bg-emerald-100', 'text-emerald-700');

            if(tabName === 'progress') {
                renderProgress();
            }
        }

        // Start App
        init();

    </script>
</body>
</html>
